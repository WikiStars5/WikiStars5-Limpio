
// Import the Workbox scripts generated by next-pwa
import { precacheAndRoute } from 'workbox-precaching';
import { registerRoute } from 'workbox-routing';
import { StaleWhileRevalidate } from 'workbox-strategies';

// Import the Firebase scripts from the CDN.
// This is the recommended way to use Firebase in a Service Worker.
importScripts('https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js');
importScripts('https://www.gstatic.com/firebasejs/9.23.0/firebase-messaging-compat.js');

// This part is crucial. It uses the self.__WB_MANIFEST which next-pwa injects,
// to precache all the necessary assets for the PWA to work offline.
precacheAndRoute(self.__WB_MANIFEST);

// Initialize Firebase
// This configuration is copied from your `src/lib/firebase.ts` file.
const firebaseConfig = {
  apiKey: "AIzaSyCwH29ruiIl_pohEoUHh7d26m5qCLCmYm0",
  authDomain: "wikistars5-2yctr.firebaseapp.com",
  projectId: "wikistars5-2yctr",
  storageBucket: "wikistars5-2yctr.appspot.com",
  messagingSenderId: "939359993461",
  appId: "1:939359993461:web:c8aab67046db949495823c",
  measurementId: "G-XCFCPXNP56"
};

// Check to avoid re-initializing the app
if (!firebase.apps.length) {
  firebase.initializeApp(firebaseConfig);
}

const messaging = firebase.messaging();

// Handle background messages
messaging.onBackgroundMessage((payload) => {
  console.log(
    '[service-worker.js] Received background message ',
    payload
  );

  const notificationTitle = payload.notification?.title || 'Nueva NotificaciÃ³n';
  const notificationOptions = {
    body: payload.notification?.body,
    icon: payload.notification?.icon || 'https://firebasestorage.googleapis.com/v0/b/wikistars5-2yctr.firebasestorage.app/o/logo%2Flogodia.png?alt=media&token=fc619841-d174-41ce-a613-3cb94cec8194',
    data: payload.data,
  };

  self.registration.showNotification(notificationTitle, notificationOptions);
});

// Handle notification clicks
self.addEventListener('notificationclick', (event) => {
  event.notification.close();
  const urlToOpen = event.notification.data?.link || '/';
  event.waitUntil(self.clients.openWindow(urlToOpen));
});
